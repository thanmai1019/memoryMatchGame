package Java_5D0;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.Timer;
import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

public class MemoryMatchUI extends JFrame {
    private JButton[][] buttons;
    private Card[][] board;
    private int rows, cols;
    private Card firstCard = null;
    private int firstRow, firstCol;
    private int clickCount = 0;
    private int currentPlayer = 1;
    private int player1Score = 0;
    private int player2Score = 0;
    private int seconds = 0;

    private JLabel scoreLabel, timerLabel, turnLabel;
    private Timer gameTimer;
    private JPanel gridPanel;

    public MemoryMatchUI(int rows, int cols) {
        this.rows = rows;
        this.cols = cols;

        // Modern UI look
        try {
            UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
        } catch (Exception ignored) {}

        board = new Card[rows][cols];
        buttons = new JButton[rows][cols];

        setTitle("Memory Match Deluxe");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLayout(new BorderLayout(12, 12));
        getContentPane().setBackground(new Color(245, 245, 250));

        // Header
        JPanel header = new JPanel(new BorderLayout());
        header.setBorder(new EmptyBorder(12, 12, 0, 12));
        header.setOpaque(false);

        JLabel title = new JLabel("Memory Match Deluxe");
        title.setFont(new Font("Segoe UI", Font.BOLD, 28));
        title.setForeground(new Color(32, 32, 80));

        header.add(title, BorderLayout.WEST);

        JPanel status = new JPanel(new FlowLayout(FlowLayout.RIGHT, 12, 0));
        status.setOpaque(false);

        scoreLabel = createPillLabel("P1: 0  |  P2: 0", new Font("Segoe UI", Font.BOLD, 14));
        timerLabel = createPillLabel("Time: 0s", new Font("Segoe UI", Font.PLAIN, 14));
        turnLabel = createPillLabel("Player 1's Turn", new Font("Segoe UI", Font.PLAIN, 14));

        status.add(scoreLabel);
        status.add(timerLabel);
        status.add(turnLabel);

        header.add(status, BorderLayout.EAST);

        add(header, BorderLayout.NORTH);

        gridPanel = new JPanel(new GridLayout(rows, cols, 10, 10));
        gridPanel.setBorder(new EmptyBorder(12, 12, 12, 12));
        gridPanel.setBackground(new Color(245, 245, 250));

        // FIXED â€” correct emoji generator
        List<String> values = generateEmojiValues(rows * cols);
        Collections.shuffle(values);

        int index = 0;
        for (int i = 0; i < rows; i++) {
            for (int j = 0; j < cols; j++) {
                Card card = new Card(values.get(index++));
                board[i][j] = card;

                JButton btn = createCardButton();
                buttons[i][j] = btn;

                int r = i, c = j;
                btn.addActionListener(e -> handleClick(r, c));

                gridPanel.add(btn);
            }
        }

        JPanel centerWrap = new JPanel(new GridBagLayout());
        centerWrap.setOpaque(false);
        centerWrap.add(gridPanel);
        add(centerWrap, BorderLayout.CENTER);

        JPanel bottom = new JPanel(new FlowLayout(FlowLayout.CENTER, 16, 12));
        bottom.setOpaque(false);

        JButton restartButton = new JButton("ğŸ”„ Restart");
        styleControlButton(restartButton);
        restartButton.addActionListener(e -> restartGame());

        JButton leaderboardButton = new JButton("ğŸ† Leaderboard");
        styleControlButton(leaderboardButton);
        leaderboardButton.addActionListener(e -> showLeaderboard());

        bottom.add(restartButton);
        bottom.add(leaderboardButton);

        add(bottom, BorderLayout.SOUTH);

        gameTimer = new Timer(1000, e -> {
            seconds++;
            timerLabel.setText("Time: " + seconds + "s");
        });
        gameTimer.start();

        updateScoreLabel();
        updateBoardColor();

        setSize(900, 800);
        setLocationRelativeTo(null);
        setVisible(true);
    }

    private JLabel createPillLabel(String text, Font font) {
        JLabel lbl = new JLabel(text);
        lbl.setOpaque(true);
        lbl.setBackground(new Color(255, 255, 255, 230));
        lbl.setBorder(BorderFactory.createCompoundBorder(
                BorderFactory.createLineBorder(new Color(220, 220, 230)),
                new EmptyBorder(6, 10, 6, 10)));
        lbl.setFont(font);
        return lbl;
    }

    private void styleControlButton(JButton b) {
        b.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        b.setBackground(Color.WHITE);
        b.setFocusPainted(false);
        b.setBorder(BorderFactory.createLineBorder(new Color(210, 210, 220)));
        b.setPreferredSize(new Dimension(140, 36));
    }

    private JButton createCardButton() {
        JButton btn = new JButton("â“");
        btn.setFont(new Font("Segoe UI Emoji", Font.PLAIN, 36));
        btn.setBackground(Color.WHITE);
        btn.setOpaque(true);
        btn.setFocusPainted(false);
        btn.setBorder(BorderFactory.createCompoundBorder(
                BorderFactory.createLineBorder(new Color(200, 200, 210), 2),
                new EmptyBorder(10, 10, 10, 10)));
        btn.setPreferredSize(new Dimension(80, 80));
        return btn;
    }

    private void handleClick(int row, int col) {
        Card clicked = board[row][col];

        if (clicked.isRevealed()) return;

        clicked.reveal();
        buttons[row][col].setText(clicked.getValue());
        clickCount++;

        if (firstCard == null) {
            firstCard = clicked;
            firstRow = row;
            firstCol = col;
        } else {
            if (firstCard.getValue().equals(clicked.getValue())) {
                if (currentPlayer == 1) player1Score += 10;
                else player2Score += 10;

                updateScoreLabel();
                firstCard = null;
                clickCount = 0;
                checkWin();
            } else {
                if (currentPlayer == 1) player1Score -= 2;
                else player2Score -= 2;

                updateScoreLabel();

                Timer delay = new Timer(600, e -> {
                    firstCard.hide();
                    clicked.hide();
                    buttons[firstRow][firstCol].setText("â“");
                    buttons[row][col].setText("â“");

                    firstCard = null;
                    if (clickCount >= 2) switchPlayer();
                    clickCount = 0;
                });

                delay.setRepeats(false);
                delay.start();
                return;
            }

            if (clickCount >= 2) {
                switchPlayer();
                clickCount = 0;
            }
        }
    }

    private void switchPlayer() {
        currentPlayer = (currentPlayer == 1) ? 2 : 1;
        turnLabel.setText("Player " + currentPlayer + "'s Turn");
        updateBoardColor();
    }

    private void updateBoardColor() {
        Color playerColor = (currentPlayer == 1) ? new Color(235, 245, 255) : new Color(235, 255, 235);
        gridPanel.setBackground(playerColor);
    }

    private void updateScoreLabel() {
        scoreLabel.setText("P1: " + player1Score + "  |  P2: " + player2Score);
    }

    private void checkWin() {
        for (int i = 0; i < rows; i++)
            for (int j = 0; j < cols; j++)
                if (!board[i][j].isRevealed()) return;

        gameTimer.stop();
        saveScore();

        JOptionPane.showMessageDialog(
                this,
                "ğŸ‰ Game Over!\nPlayer 1: " + player1Score +
                        "\nPlayer 2: " + player2Score +
                        "\nğŸ† Winner: " +
                        (player1Score > player2Score ? "Player 1" :
                                player2Score > player1Score ? "Player 2" : "It's a tie!"),
                "Game Over",
                JOptionPane.INFORMATION_MESSAGE
        );
    }

    private void restartGame() {
        dispose();
        startGame();
    }

    private void showLeaderboard() {
        try (BufferedReader reader = new BufferedReader(new FileReader("scores.txt"))) {
            StringBuilder sb = new StringBuilder();
            String line;

            while ((line = reader.readLine()) != null)
                sb.append(line).append("\n");

            JOptionPane.showMessageDialog(this, sb.toString(), "Leaderboard", JOptionPane.INFORMATION_MESSAGE);

        } catch (IOException ex) {
            JOptionPane.showMessageDialog(this, "No leaderboard file found.", "Leaderboard", JOptionPane.INFORMATION_MESSAGE);
        }
    }

    private void saveScore() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter("scores.txt", true))) {
            writer.write("P1: " + player1Score + ", P2: " + player2Score + " in " + seconds + "s\n");
        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }

    // FIXED â€” emojis appear exactly twice, no extra repeats
    private List<String> generateEmojiValues(int count) {
        String[] pool = {
            "ğŸ","ğŸš—","ğŸ¶","ğŸµ","ğŸŒŸ","ğŸ€","ğŸ²","ğŸ“š",
            "ğŸ®","ğŸ©","ğŸ±","ğŸ§ ","ğŸª","ğŸ","ğŸ§¸","ğŸ•",
            "âš½","ğŸ§","ğŸ¯","ğŸš€","ğŸ¼","ğŸª","ğŸ’","ğŸ¸",
            "ğŸ¥‘","ğŸ¦„","ğŸ¥","ğŸ“","ğŸ¹","ğŸ§ƒ","ğŸ“·","ğŸ’",
            "ğŸ¦‹","ğŸ¢","ğŸˆ","ğŸ”","ğŸ°","ğŸŒ™","ğŸ”¥","âš¡",
            "ğŸŒˆ","ğŸ³","ğŸ‰","ğŸŸ","ğŸ­","ğŸ›¸","ğŸƒ","ğŸ§©",
            "ğŸ§ª","ğŸŒ»","ğŸ¦Š","ğŸ","ğŸ¥¥","ğŸ¥¨","ğŸ¿","ğŸ§‹",
            "ğŸ¥•","ğŸ‡","ğŸ‘","ğŸŒ´","ğŸ€","ğŸ™","ğŸ¦","ğŸ¨"
        };

        List<String> values = new ArrayList<>();
        int pairs = count / 2;

        for (int i = 0; i < pairs; i++) {
            values.add(pool[i]);
            values.add(pool[i]);
        }

        return values;
    }

    public static void startGame() {
        String[] options = {"Easy (4x4)", "Medium (6x6)", "Hard (8x8)"};
        int choice = JOptionPane.showOptionDialog(
                null,
                "Choose difficulty",
                "Memory Match",
                JOptionPane.DEFAULT_OPTION,
                JOptionPane.INFORMATION_MESSAGE,
                null,
                options,
                options[0]
        );

        int size = switch (choice) {
            case 1 -> 6;
            case 2 -> 8;
            default -> 4;
        };

        new MemoryMatchUI(size, size);
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(MemoryMatchUI::startGame);
    }

    static class Card {
        private String value;
        private boolean isRevealed;

        public Card(Object object) {
            this.value = (String) object;
            this.isRevealed = false;
        }

        public String getValue() { return value; }
        public boolean isRevealed() { return isRevealed; }
        public void reveal() { isRevealed = true; }
        public void hide() { isRevealed = false; }
    }
}
